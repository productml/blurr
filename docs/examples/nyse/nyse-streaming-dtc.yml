Type: Blurr:Transform:Streaming
Version: '2018-03-01'
Description: New York Store Exchange Transformations
Name: nyse

Import:
  - { Module: dateutil.parser, Identifiers: [ parse ]}

Identity: source.symbol

Time: parse(source.datetime)

Stores:
  - Type: Blurr:Store:Memory
    Name: memory

Aggregates:
  - Type: Blurr:Aggregate:Block
    Name: stats
    Store: memory
    Split: time.date() != stats.latest_tradetime.date()
    When: source.symbol in ['AAPL', 'MSFT', 'GOOG', 'FB']
    Fields:
      - Name: close
        Type: float
        Value: source.price

      - Name: high
        Type: float
        Value: source.price
        When: source.price >= stats.high
    
      - Name: low
        Type: float
        Value: source.price
        When: (stats.low == 0 or source.price < stats.low)

      - Name: volatility
        Type: float
        Value: (float(stats.high) / float(stats.low)) - 1
        When: stats.low > 0

      - Name: volume
        Type: float
        Value: stats.volume + source.volume

      - Name: latest_tradetime
        Type: datetime
        Value: time