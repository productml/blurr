####
# Header block that defines the properties of this DTC
####

# Type of DTC. Streaming or Window
# The Window DTC applies windows operations on top of sessionized data

Type: ProductML:DTC:Window
Version: '2018-03-01'
Description: Second Level processing for feature generation

Name: ProductMLExample

# The DTC used in Step 1

SourceDTC: offer_ai_v1

# Anchor defines the condition used to trigger the decision
# If an offer is shown to the user in this session, the session
# in which the offer is shown is the anchor

Anchor:

 Condition:  offer_ai_v1.game_stats.offer_type != ''
 Max: 1

##
# Max defines the maximum number of output rows to be generated. If the number of sessions that satisfy the anchor condition
# is more than the max value specified, then, a ‘max’ number of satisfying sessions are picked randomly
# By setting max = 1, we're making sure that we are only seeing 1 test_offer per session in the data and filtering out the rest
# If we wanted to record multiple offers, set max to a higher number
##

##
# Window aggregations are stored in S3 (a Store)
# Defines the Store properties
##

Store:
   - Type: ProductML:DTC:Storage:S3
     Name: s3
     Bucket: offer-ai-example
     Prefix: /dtc-test/window/


DataGroups:

 - Type: ProductML:DTC:DataGroup:AnchorAggregate
   Name: last_session

   Window:

# Defines a processing window for the rollup. Supported window types are Day, Hour and Count

    - Type: count

# Negative values are backward from the Anchor

      Value: -1
      Source: offer_ai_v1.game_stats
      Name: prev_session

   Fields:
     - Name: games_played_last_session
       Type: integer
       Value: prev_session.games_played[0]

# Field values such as prev_session.games_played is stored as list with length (max) as defined in the Anchor condition

     - Name: win_ratio_last_session
       Type: float
       Value: prev_session.win_ratio[0]

 - Type: ProductML:DTC:DataGroup:AnchorAggregate
   Name: last_week
   Window:
     - Type: day
       Values: -7
       Source: offer_ai_v1.game_stats
       Name: prev_week

   Fields:
     - Name: purchases_prev_week_amount
       Type: float
       Value: sum(prev_week.purchase_amount)


  - Type: ProductML:DTC:DataGroup:AnchorAggregate
    Name: 7_day_revenue
    Window:
      - Type: day
        Values: 7
        Source: offer_ai_v1.game_stats
        Name: next_7

    Fields:
      - Name: next_7_days_revenue
        Type: float
        Value: sum(next_7.purchase_amount)
